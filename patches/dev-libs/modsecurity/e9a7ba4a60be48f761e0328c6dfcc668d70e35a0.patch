From e9a7ba4a60be48f761e0328c6dfcc668d70e35a0 Mon Sep 17 00:00:00 2001
From: Martin Vierula <martin.vierula@trustwave.com>
Date: Thu, 15 Sep 2022 13:44:40 -0700
Subject: [PATCH] Fix two rule-reload memory leak issues

---
 headers/modsecurity/rule.h     | 2 ++
 src/rule_with_actions.cc       | 4 ++++
 test/cppcheck_suppressions.txt | 8 ++++++--
 4 files changed, 14 insertions(+), 2 deletions(-)

diff --git a/headers/modsecurity/rule.h b/headers/modsecurity/rule.h
index b10e0556e..1d5570a8d 100644
--- a/headers/modsecurity/rule.h
+++ b/headers/modsecurity/rule.h
@@ -86,6 +86,8 @@ class Rule {
         return *this;
     }
 
+    virtual ~Rule() {}
+
     virtual bool evaluate(Transaction *transaction) = 0;
 
     virtual bool evaluate(Transaction *transaction,
diff --git a/src/rule_with_actions.cc b/src/rule_with_actions.cc
index ccf726535..39c1c1c8c 100644
--- a/src/rule_with_actions.cc
+++ b/src/rule_with_actions.cc
@@ -80,6 +80,10 @@ RuleWithActions::RuleWithActions(
     m_containsStaticBlockAction(false),
     m_isChained(false) {
 
+    if (transformations != NULL) {
+        delete transformations;
+    }
+
     if (actions) {
         for (Action *a : *actions) {
             if (a->action_kind == Action::ConfigurationKind) {
diff --git a/test/cppcheck_suppressions.txt b/test/cppcheck_suppressions.txt
index 3680cf1b4..59e869d83 100644
--- a/test/cppcheck_suppressions.txt
+++ b/test/cppcheck_suppressions.txt
@@ -55,8 +55,8 @@ danglingTempReference:src/modsecurity.cc:206
 knownConditionTrueFalse:src/operators/validate_url_encoding.cc:77
 knownConditionTrueFalse:src/operators/verify_svnr.cc:87
 rethrowNoCurrentException:headers/modsecurity/transaction.h:309
-rethrowNoCurrentException:src/rule_with_actions.cc:123
-ctunullpointer:src/rule_with_actions.cc:237
+rethrowNoCurrentException:src/rule_with_actions.cc:127
+ctunullpointer:src/rule_with_actions.cc:241
 ctunullpointer:src/rule_with_operator.cc:135
 ctunullpointer:src/rule_with_operator.cc:95
 passedByValue:src/variables/global.h:109
@@ -93,6 +93,10 @@ functionStatic
 variableScope
 shadowFunction
 
+constVariable
+stlcstrConstructor
+stlcstrStream
+uselessCallsSubstr
 
 // Examples
 memleak:examples/reading_logs_via_rule_message/reading_logs_via_rule_message.h:147
